import pytest
import geopandas as gpd

from shapely import from_wkt 

from potentiel_solaire.features.attach_buildings_to_schools import attach_buildings_to_schools


TEST_CRS = "EPSG:4326"


@pytest.mark.parametrize(
    "schools_establishments, "
    "educational_zones, "
    "buildings, "
    "schools_buildings_expected", [
    
    # Test 1
    # Cas standard avec un etablissement correspondant une zone d'education
    (
        # schools_establishments
        gpd.GeoDataFrame(
            {       
                "identifiant_de_l_etablissement": [
                    "0932595R",
                ],
                "nombre_d_eleves": [
                    100,
                ],
                "geometry": map(from_wkt, [
                    "POINT (2.3590491366730153 48.93021698801084)",
                ]),
            },
            crs=TEST_CRS
        ),
        # Test 1 : educational_zones
        gpd.GeoDataFrame(
            {
                "cleabs": [
                    "SURFACTI0000000351259092",
                ],
                "identifiants_sources": [
                    "MEN:0932595R",  # va matcher avec l'etablissement
                ],
                "geometry": map(from_wkt, [
                    "MULTIPOLYGON (((2.3587491817298756 48.93063441269705, 2.3598599465495336 48.93065384046415, 2.3598423218781197 48.930200504216316, 2.358776592997671 48.930182216498416, 2.3587491817298756 48.93063441269705)))",
                ]),
            },
            crs=TEST_CRS
        ), 
        # Test 1 : buildings
        gpd.GeoDataFrame(
            {
                "cleabs": [
                    "BATIMENT0000000353684236",  # majoritairement dans la zone d'education
                    "BATIMENT0000000353684238",  # majoritairement dans la zone d'education
                    "BATIMENT0000000353684239",  # majoritairement dans la zone d'education
                    "BATIMENT0000000002632136"   # totalement hors de la zone d'education
                ],
                "geometry": map(from_wkt, [
                    "MULTIPOLYGON Z (((2.3589969692996844 48.930463074668985 49.4, 2.358993366505047 48.930644711949675 49.4, 2.358944256586293 48.93064265067886 49.4, 2.3589400533513714 48.930762233730086 49.4, 2.358936791928668 48.930805382188105 49.4, 2.3587675919419286 48.930801779098736 49.4, 2.3587799811277477 48.93046101454944 49.4, 2.3589969692996844 48.930463074668985 49.4)))",
                    "MULTIPOLYGON Z (((2.3590030669075865 48.9301897231096 42.8, 2.358999597103289 48.93036056966733 42.8, 2.3589977559248854 48.93039922928931 42.8, 2.358997445706727 48.930424407749335 42.8, 2.3589972684390728 48.93043879544054 42.8, 2.3589969692996844 48.930463074668985 42.8, 2.3587799811277477 48.93046101454944 42.8, 2.3587888426597323 48.9301849799126 42.8, 2.3590030669075865 48.9301897231096 42.8)))",
                    "MULTIPOLYGON Z (((2.3598205077128807 48.93019858910714 38.7, 2.3598421822757474 48.930655544152415 38.7, 2.3597657545747284 48.9306551358698 38.7, 2.3597666103199995 48.9306965077671 38.7, 2.359851237835163 48.9306960605602 38.7, 2.35984420752938 48.93082372213087 38.7, 2.359752800147534 48.93082053595445 38.7, 2.359754773574338 48.93077108557013 38.7, 2.359659227669084 48.93077147437008 38.7, 2.3596586632076746 48.93081733512351 38.7, 2.359569952209192 48.93081686108373 38.7, 2.3595691298265806 48.93077279149823 38.7, 2.359477700409068 48.93077140357278 38.7, 2.3594758374293123 48.93081186164829 38.7, 2.3593843968730073 48.93081137288213 38.7, 2.359383596792907 48.93076550483423 38.7, 2.359290802609991 48.93076410947064 38.7, 2.359290215675407 48.93081176868343 38.7, 2.3592015046897736 48.9308112943709 38.7, 2.359200726922485 48.9307636278609 38.7, 2.359106556887329 48.930763124287445 38.7, 2.359104616077078 48.93080987697027 38.7, 2.359010445959141 48.93080937332131 38.7, 2.359009646208754 48.93076350527083 38.7, 2.3589400533513714 48.930762233730086 38.7, 2.358944256586293 48.93064265067886 38.7, 2.358993366505047 48.930644711949675 38.7, 2.3589969692996844 48.930463074668985 38.7, 2.3589972684390728 48.93043879544054 38.7, 2.358997445706727 48.930424407749335 38.7, 2.359087554038058 48.93042219181986 38.7, 2.359086047471746 48.93054448719024 38.7, 2.359567824975469 48.9305461635161 38.7, 2.359554657835684 48.93028529907209 38.7, 2.359086519375593 48.930284594913815 38.7, 2.359086920390672 48.93036283529211 38.7, 2.358999597103289 48.93036056966733 38.7, 2.3590030669075865 48.9301897231096 38.7, 2.3598205077128807 48.93019858910714 38.7), (2.359013406123974 48.93067989143767 38.7, 2.3591089186338037 48.930682200844046 38.7, 2.3591083292682797 48.930619247408444 38.7, 2.3590141816533063 48.93061694530123 38.7, 2.359013406123974 48.93067989143767 38.7), (2.3593886876707457 48.930684595976565 38.7, 2.3594787410812375 48.93068687590611 38.7, 2.359476742204731 48.93062751210047 38.7, 2.359388020459054 48.930627937156515 38.7, 2.3593886876707457 48.930684595976565 38.7), (2.3591990274068717 48.93067998483128 38.7, 2.3592904345078636 48.93068317143049 38.7, 2.359289778477408 48.93062561337924 38.7, 2.3591997030296925 48.930625131768686 38.7, 2.3591990274068717 48.93067998483128 38.7), (2.3595715462007987 48.93068737189377 38.7, 2.359660256978504 48.93068784593242 38.7, 2.35965955626755 48.930633884805815 38.7, 2.3595708566512177 48.93063251153604 38.7, 2.3595715462007987 48.93068737189377 38.7)))",
                    "MULTIPOLYGON Z (((2.359140483025784 48.938424327281645 40.7, 2.3591432928827913 48.938528659162564 40.6, 2.3591064160798787 48.93853026055259 40.6, 2.3590149287174564 48.93853246917995 40.7, 2.3590093780685892 48.93842902192096 41.9, 2.359140483025784 48.938424327281645 40.7)))",
                ]),
            },
            crs=TEST_CRS
        ),
        # Test 1 : schools_buildings_expected
        gpd.GeoDataFrame(
            {
                "cleabs_bat": [
                    "BATIMENT0000000353684236",
                    "BATIMENT0000000353684238",
                    "BATIMENT0000000353684239",
                ],
                "cleabs_grande_zone": [
                    "SURFACTI0000000351259092",
                    "SURFACTI0000000351259092",
                    "SURFACTI0000000351259092",
                ],
                "identifiant_de_l_etablissement": [
                    "0932595R",
                    "0932595R",
                    "0932595R",
                ],
                "geometry": map(from_wkt, [
                    "MULTIPOLYGON Z (((2.3589969692996844 48.930463074668985 49.4, 2.358993366505047 48.930644711949675 49.4, 2.358944256586293 48.93064265067886 49.4, 2.3589400533513714 48.930762233730086 49.4, 2.358936791928668 48.930805382188105 49.4, 2.3587675919419286 48.930801779098736 49.4, 2.3587799811277477 48.93046101454944 49.4, 2.3589969692996844 48.930463074668985 49.4)))",
                    "MULTIPOLYGON Z (((2.3590030669075865 48.9301897231096 42.8, 2.358999597103289 48.93036056966733 42.8, 2.3589977559248854 48.93039922928931 42.8, 2.358997445706727 48.930424407749335 42.8, 2.3589972684390728 48.93043879544054 42.8, 2.3589969692996844 48.930463074668985 42.8, 2.3587799811277477 48.93046101454944 42.8, 2.3587888426597323 48.9301849799126 42.8, 2.3590030669075865 48.9301897231096 42.8)))",
                    "MULTIPOLYGON Z (((2.3598205077128807 48.93019858910714 38.7, 2.3598421822757474 48.930655544152415 38.7, 2.3597657545747284 48.9306551358698 38.7, 2.3597666103199995 48.9306965077671 38.7, 2.359851237835163 48.9306960605602 38.7, 2.35984420752938 48.93082372213087 38.7, 2.359752800147534 48.93082053595445 38.7, 2.359754773574338 48.93077108557013 38.7, 2.359659227669084 48.93077147437008 38.7, 2.3596586632076746 48.93081733512351 38.7, 2.359569952209192 48.93081686108373 38.7, 2.3595691298265806 48.93077279149823 38.7, 2.359477700409068 48.93077140357278 38.7, 2.3594758374293123 48.93081186164829 38.7, 2.3593843968730073 48.93081137288213 38.7, 2.359383596792907 48.93076550483423 38.7, 2.359290802609991 48.93076410947064 38.7, 2.359290215675407 48.93081176868343 38.7, 2.3592015046897736 48.9308112943709 38.7, 2.359200726922485 48.9307636278609 38.7, 2.359106556887329 48.930763124287445 38.7, 2.359104616077078 48.93080987697027 38.7, 2.359010445959141 48.93080937332131 38.7, 2.359009646208754 48.93076350527083 38.7, 2.3589400533513714 48.930762233730086 38.7, 2.358944256586293 48.93064265067886 38.7, 2.358993366505047 48.930644711949675 38.7, 2.3589969692996844 48.930463074668985 38.7, 2.3589972684390728 48.93043879544054 38.7, 2.358997445706727 48.930424407749335 38.7, 2.359087554038058 48.93042219181986 38.7, 2.359086047471746 48.93054448719024 38.7, 2.359567824975469 48.9305461635161 38.7, 2.359554657835684 48.93028529907209 38.7, 2.359086519375593 48.930284594913815 38.7, 2.359086920390672 48.93036283529211 38.7, 2.358999597103289 48.93036056966733 38.7, 2.3590030669075865 48.9301897231096 38.7, 2.3598205077128807 48.93019858910714 38.7), (2.359013406123974 48.93067989143767 38.7, 2.3591089186338037 48.930682200844046 38.7, 2.3591083292682797 48.930619247408444 38.7, 2.3590141816533063 48.93061694530123 38.7, 2.359013406123974 48.93067989143767 38.7), (2.3593886876707457 48.930684595976565 38.7, 2.3594787410812375 48.93068687590611 38.7, 2.359476742204731 48.93062751210047 38.7, 2.359388020459054 48.930627937156515 38.7, 2.3593886876707457 48.930684595976565 38.7), (2.3591990274068717 48.93067998483128 38.7, 2.3592904345078636 48.93068317143049 38.7, 2.359289778477408 48.93062561337924 38.7, 2.3591997030296925 48.930625131768686 38.7, 2.3591990274068717 48.93067998483128 38.7), (2.3595715462007987 48.93068737189377 38.7, 2.359660256978504 48.93068784593242 38.7, 2.35965955626755 48.930633884805815 38.7, 2.3595708566512177 48.93063251153604 38.7, 2.3595715462007987 48.93068737189377 38.7)))",
                ]),
            },
            crs=TEST_CRS
        ),
    ),

    # Test 2
    # Overlap entre plusieurs zones d education et un etablissement
    # Un des batiments est majoritaiterement en dehors de la zone d education et ne sera pas retenu
    (
        # Test 2 : schools_establishments
        gpd.GeoDataFrame(
            {       
                "identifiant_de_l_etablissement": [
                    "0930419A",
                ],
                "nombre_d_eleves": [
                    100,
                ],
                "geometry": map(from_wkt, [
                    "POINT (2.358681795889019 48.9377618395158)",
                ]),
            },
            crs=TEST_CRS
        ),
        # Test 2 : educational_zones
        gpd.GeoDataFrame(
            {
                "cleabs": [
                    "SURFACTI0000000002555603",  # grande zone
                    "SURFACTI0000000246200199",  # inclue dans la grande zone
                    "SURFACTI0000000351259753",  # inclue dans la grande zone
                    "SURFACTI0000000246200194",  # inclue dans la grande zone
                ],
                "identifiants_sources": [
                    "MEN:0930946Y",
                    "MEN:0931094J",
                    "MEN:0932586F",
                    "MEN:0930419A",  # va matcher avec l'etablissement
                ],
                "geometry": map(from_wkt, [
                    "MULTIPOLYGON (((2.359140483025784 48.938424327281645, 2.3591432928827913 48.938528659162564, 2.3591064160798787 48.93853026055259, 2.3590875189933542 48.93862368495752, 2.359050675361515 48.93862258865859, 2.3590490887706417 48.93864056583692, 2.358963094415767 48.93864010594996, 2.3588022140621336 48.938623957602765, 2.3588088378637115 48.938529568301156, 2.358816372179076 48.93847205447719, 2.3588222200592424 48.938440610844665, 2.358729401114585 48.93844011428031, 2.358732807299459 48.93838527622011, 2.35863728066268 48.938382966530426, 2.3586129216333385 48.93836574979897, 2.358588618060021 48.93834403694189, 2.358541220711983 48.9383132076542, 2.3582858472257087 48.938321732795494, 2.35827982103772 48.93825695212048, 2.358270920694243 48.93820384673919, 2.35823275677521 48.93819914598358, 2.35823336613997 48.93792846485857, 2.3582295703706793 48.937793551957, 2.3587825928174926 48.93777942541555, 2.358927312582319 48.93777750170296, 2.3589271241882006 48.93779278852075, 2.3591168657544177 48.93779290394305, 2.359140483025784 48.938424327281645)))",
                    "MULTIPOLYGON (((2.3584651015878375 48.93806549727915, 2.3583968528583084 48.93806513196181, 2.3583974074195657 48.93802017074626, 2.3584656560901096 48.93802053606328, 2.3584651015878375 48.93806549727915)))",
                    "MULTIPOLYGON (((2.3584712943338078 48.93811678959258, 2.35840304553694 48.938116424278796, 2.3584036000933915 48.938071463065334, 2.3584718488312744 48.938071828378824, 2.3584712943338078 48.93811678959258)))",
                    "MULTIPOLYGON (((2.3585901668820544 48.93788630987553, 2.3585219183867383 48.937885944629365, 2.3585224728379894 48.937840983405756, 2.3585907212743207 48.93784134865164, 2.3585901668820544 48.93788630987553)))",                
                ]),
            },
            crs=TEST_CRS
        ), 
        # Test 2 : buildings
        gpd.GeoDataFrame(
            {
                "cleabs": [
                    "BATIMENT0000000002632143",  # majoritairement hors des zones d'education
                    "BATIMENT0000000002632136",  # majoritairement dans la zone d'education
                    "BATIMENT0000002011629925",  # majoritairement dans la zone d'education
                    "BATIMENT0000002011629926",  # majoritairement dans la zone d'education
                ],
                "geometry": map(from_wkt, [
                    "MULTIPOLYGON Z (((2.3574906086089 48.93816279573541 48.4, 2.3574917847686008 48.93817808986252 48.6, 2.357439904519203 48.93817871102782 48.6, 2.357439215834794 48.938234462921166 48.6, 2.357515643546709 48.93823577190867 48.6, 2.3575243443125933 48.93819445150102 48.6, 2.3575812291682388 48.93823072775122 48.6, 2.3575428209591025 48.938245809705684 48.6, 2.357540978418966 48.93828446902323 48.6, 2.357573438095344 48.938308923662895 48.6, 2.357547381293349 48.938318676118065 48.6, 2.3575507987759354 48.938373550730006 48.6, 2.357628069761867 48.938417130487124 48.6, 2.3576249511315845 48.938448588693134 48.6, 2.3577112338403965 48.938425669718335 48.6, 2.357717903317451 48.93843829542579 48.6, 2.35778487636265 48.93843146002446 48.4, 2.3578136409415413 48.938423520593346 48.5, 2.357812664506979 48.93839204044161 48.5, 2.3578713920808054 48.93838965723091 48.5, 2.357871858296733 48.93835188982336 48.5, 2.3578952294908366 48.93833852577702 48.5, 2.357886540427986 48.93826833511387 48.5, 2.3578143186117635 48.938258056062345 48.8, 2.357792800888643 48.938231861547955 48.8, 2.357791924385775 48.938192288373315 48.8, 2.3577666670385087 48.93813729673845 45.8, 2.3578676308905315 48.93814143482204 48.9, 2.3578680638058134 48.938106365078454 49, 2.357899702440879 48.938086750334904 48.9, 2.357925370582088 48.938108470648956 48.5, 2.357977295149621 48.93810425237659 48.5, 2.3579763408190244 48.93807097376837 48.5, 2.3579561214725953 48.93805018193589 48.5, 2.3578906471148793 48.938046234056735 48.5, 2.3578855868212982 48.93801383273274 48.5, 2.357919899841461 48.937998728728786 48.5, 2.3579176693735935 48.93795824900999 48.6, 2.3579451352931593 48.93794490688557 48.6, 2.3579468776300976 48.93791434056908 48.7, 2.3578609399878467 48.93790938376915 46.9, 2.3578187147146084 48.9379019632687 46.9, 2.3577577351450905 48.93786566517819 50.9, 2.3576812635566 48.93786795324216 50.9, 2.3576815411455447 48.937845472632155 50.8, 2.3577703529290823 48.937838754271326 51, 2.357815430195248 48.93783629794734 48.9, 2.3578144981756086 48.937801220880665 46.4, 2.358203635989553 48.937793413090006 46.1, 2.358196090000368 48.93785182613606 48.5, 2.3581672037492027 48.937869657131984 48.5, 2.3581193743398066 48.93787389741728 48.6, 2.35807957938688 48.93789077068766 49.1, 2.3580579950998173 48.93786997155852 49.1, 2.358033192603387 48.93788872367798 49, 2.357997670091799 48.93789123126311 48.8, 2.3579998340306294 48.9379371063291 48.8, 2.3580434687188694 48.93794093717883 48.8, 2.3580791244225936 48.93792763888777 49, 2.3581392830047436 48.93791986750883 48.9, 2.358142878615212 48.93796035453457 48.8, 2.358111273437176 48.937977271671585 48.8, 2.358113504056514 48.938017751386056 48.8, 2.358087369825583 48.93803379853131 48.8, 2.3580895782356492 48.93807607669261 48.8, 2.3580539224328514 48.938089374984955 48.8, 2.358051936014357 48.93813972423057 48.8, 2.357980890646759 48.93814473940027 48.4, 2.3579475762572932 48.93818952512878 48.4, 2.3579801359518027 48.93820588664328 48.4, 2.3579768510691177 48.93825083322619 48.4, 2.358012307239747 48.93825372099266 48.4, 2.3580145155981413 48.93829599914673 48.5, 2.358040283767613 48.93830962641552 48.5, 2.3580703244454577 48.938308888025155 48.1, 2.3580924859403027 48.93828292749232 47.2, 2.3581190530419343 48.93823181060923 46.6, 2.358166893875688 48.93822667110132 46.6, 2.358192617671525 48.93824389523473 46.6, 2.358198954401217 48.93828349764061 46.5, 2.3581441998511186 48.93829579440583 46.4, 2.3581204625700467 48.93833883289493 48.8, 2.3581723984468757 48.9383337153149 48.8, 2.3582075884153073 48.93835818440028 48.8, 2.3582099189767667 48.93839057108267 48.8, 2.3582397378185496 48.93840781712984 48.8, 2.358301860934578 48.938351494884245 48.9, 2.358337172991594 48.93836607246685 48.9, 2.3583407576946493 48.93840745869391 48.9, 2.3583105505717237 48.93842168551187 48.6, 2.3583155446133404 48.93845948214944 48.2, 2.3583371403403444 48.938479381996885 45.8, 2.3583970333303856 48.9384931918671 45.8, 2.3584597561367726 48.938498923303875 45.8, 2.3584748042524324 48.93849630599728 48.2, 2.358561064488982 48.938475184859676 48.2, 2.3585740268705533 48.938531009792044 48.4, 2.3586399786369827 48.93849629066672 48.4, 2.3586988725821794 48.93848041869137 48.2, 2.358816372179076 48.93847205447719 49.1, 2.3588088378637115 48.938529568301156 47, 2.3589752000392488 48.938543947393676 47, 2.3590147071043797 48.938550453659 47.9, 2.3590149287174564 48.93853246917995 47, 2.3591064160798787 48.93853026055259 40.7, 2.3590875189933542 48.93862368495752 41.6, 2.359050675361515 48.93862258865859 45.1, 2.3590490887706417 48.93864056583692 45.1, 2.358963094415767 48.93864010594996 47.3, 2.3588022140621336 48.938623957602765 47.3, 2.358759943734279 48.938620134334265 47.3, 2.358589508584246 48.93860393458274 50.5, 2.3585294490797812 48.938603613168034 50.5, 2.3583316810127117 48.9385899646137 46.3, 2.3582675487481564 48.93858782269757 46.3, 2.35822389131212 48.9385857903794 48.5, 2.358173763985159 48.938554946335884 48.3, 2.358199965019699 48.938533503836254 48.6, 2.358170168309552 48.93851445933338 48.6, 2.3582018514577 48.93849124762183 48.3, 2.358178790936498 48.938479433456415 48.2, 2.3580879361339155 48.93843038561135 45.8, 2.358044245544806 48.93843105089931 45.8, 2.35797567447942 48.93845676283668 48.9, 2.3579874488164294 48.93849819293972 48.8, 2.35795165950988 48.93852228188299 48.8, 2.357880480407017 48.938538087677706 48.8, 2.357816337123627 48.938536844743915 48.8, 2.3577919671921506 48.938520527071915 48.8, 2.3577658437116784 48.93853567491574 48.8, 2.3577386216939624 48.93852923406738 48.8, 2.3577329285882755 48.93854808851092 48.4, 2.35768788401219 48.93854784713079 50.9, 2.3576210551661494 48.93854299256755 51.1, 2.357569529934788 48.93851483862608 45.5, 2.357520434855419 48.93851097833914 45.7, 2.357507218155501 48.93847583544095 45.5, 2.357360921784802 48.93838422351587 47, 2.357280276693738 48.93839278393473 49.2, 2.357217431916687 48.93839694334319 48.6, 2.3571940271859058 48.938413004928336 48.6, 2.3572238457037433 48.938430251227885 48.6, 2.35720041873596 48.93844811126149 48.6, 2.3572206601583137 48.9384671047661 48.6, 2.3571917510068148 48.93848673396444 48.6, 2.357173806171277 48.938502824825974 49.1, 2.3568477524432603 48.93848668716357 44.5, 2.3568013540579473 48.938485538902086 47, 2.356790434174854 48.93848548030237 46.3, 2.356799469126425 48.938417183241725 46.4, 2.3568472101981626 48.9384201372761 48.3, 2.3568898248611427 48.938396085280004 48.2, 2.35694715414972 48.938396392869876 48.2, 2.356974120334202 48.938423516047806 48, 2.3570751513636563 48.938422259454676 47.7, 2.3571220942525835 48.938379345639405 47.9, 2.357038109987018 48.9383267367043 48.2, 2.356971526036103 48.93830209885078 46.2, 2.357030664798271 48.93826644476457 46.4, 2.357046811147437 48.93828541633478 48.6, 2.3571356015378964 48.93828049689499 48.7, 2.357137566622609 48.93823194611918 45.8, 2.357095274508119 48.93822992071034 45.3, 2.357093189151398 48.93817775107194 48.4, 2.3569429749465702 48.93818234094841 48.4, 2.356914610575984 48.938157908106035 48.4, 2.356923011654739 48.93814086678983 48.4, 2.3570199472074442 48.93813958827227 54.3, 2.3570203806941934 48.93810451853168 54.4, 2.357055892284114 48.93810291046081 54.4, 2.357059531521498 48.93813980061576 54.4, 2.357163280837953 48.93813945781601 48.6, 2.357169827908211 48.938161975022425 48.6, 2.3572064489374926 48.93818105638183 48.6, 2.357247353816809 48.9381848728799 48.6, 2.3572256013301303 48.938288173845535 48.5, 2.3572675046188767 48.938321672047834 48.5, 2.357328950990687 48.9383202029659 48.5, 2.3574074658524733 48.938263069780874 48.6, 2.357377958418408 48.9382206452507 48.6, 2.357382586576408 48.938177504449456 48.6, 2.3574308051035193 48.938141791614946 48.3, 2.357488145222001 48.93814119972199 48.4, 2.3574906086089 48.93816279573541 48.4)))",
                    "MULTIPOLYGON Z (((2.359140483025784 48.938424327281645 40.7, 2.3591432928827913 48.938528659162564 40.6, 2.3591064160798787 48.93853026055259 40.6, 2.3590149287174564 48.93853246917995 40.7, 2.3590093780685892 48.93842902192096 41.9, 2.359140483025784 48.938424327281645 40.7)))",
                    "MULTIPOLYGON Z (((2.358816372179076 48.93847205447719 49.1, 2.3586988725821794 48.93848041869137 48.2, 2.3586399786369827 48.93849629066672 48.4, 2.3585740268705533 48.938531009792044 48.4, 2.358561064488982 48.938475184859676 48.2, 2.3584748042524324 48.93849630599728 48.2, 2.3584597561367726 48.938498923303875 45.8, 2.3583970333303856 48.9384931918671 45.8, 2.3583371403403444 48.938479381996885 45.8, 2.3583155446133404 48.93845948214944 48.2, 2.3583105505717237 48.93842168551187 48.6, 2.3583407576946493 48.93840745869391 48.9, 2.358337172991594 48.93836607246685 48.9, 2.358301860934578 48.938351494884245 48.9, 2.3582397378185496 48.93840781712984 48.8, 2.3582099189767667 48.93839057108267 48.8, 2.3582075884153073 48.93835818440028 48.8, 2.3581723984468757 48.9383337153149 48.8, 2.3581204625700467 48.93833883289493 48.8, 2.3581441998511186 48.93829579440583 46.4, 2.358198954401217 48.93828349764061 46.5, 2.358192617671525 48.93824389523473 46.6, 2.358166893875688 48.93822667110132 46.6, 2.3581190530419343 48.93823181060923 46.6, 2.3580924859403027 48.93828292749232 47.2, 2.3580703244454577 48.938308888025155 48.1, 2.358040283767613 48.93830962641552 48.5, 2.3580145155981413 48.93829599914673 48.5, 2.358012307239747 48.93825372099266 48.4, 2.3579768510691177 48.93825083322619 48.4, 2.3579801359518027 48.93820588664328 48.4, 2.3579475762572932 48.93818952512878 48.4, 2.357980890646759 48.93814473940027 48.4, 2.358051936014357 48.93813972423057 48.8, 2.3580539224328514 48.938089374984955 48.8, 2.3580895782356492 48.93807607669261 48.8, 2.358087369825583 48.93803379853131 48.8, 2.358113504056514 48.938017751386056 48.8, 2.358111273437176 48.937977271671585 48.8, 2.358142878615212 48.93796035453457 48.8, 2.3581392830047436 48.93791986750883 48.9, 2.3580791244225936 48.93792763888777 49, 2.3580434687188694 48.93794093717883 48.8, 2.3579998340306294 48.9379371063291 48.8, 2.357997670091799 48.93789123126311 48.8, 2.358033192603387 48.93788872367798 49, 2.3580579950998173 48.93786997155852 49.1, 2.35807957938688 48.93789077068766 49.1, 2.3581193743398066 48.93787389741728 48.6, 2.3581672037492027 48.937869657131984 48.5, 2.358196090000368 48.93785182613606 48.5, 2.358203635989553 48.937793413090006 46.1, 2.3582295703706793 48.937793551957 46, 2.3587825928174926 48.93777942541555 44.1, 2.358927312582319 48.93777750170296 44.1, 2.3589271241882006 48.93779278852075 44.1, 2.3591168657544177 48.93779290394305 41.7, 2.3591313777310043 48.93816618426028 41.4, 2.3590071647950417 48.93816552004427 41.2, 2.3590045858809994 48.93793169251081 41.1, 2.35892672711499 48.93793577251835 38.1, 2.3588256416561584 48.937941526794916 38.3, 2.358824043924461 48.937960403206034 38.2, 2.358630184657995 48.93796206385684 38.2, 2.35849497481424 48.93796763524758 38.6, 2.3584959969752965 48.93810613040486 38.5, 2.358637954447124 48.9381068901038 37.9, 2.358639119855831 48.938123083444715 37.9, 2.3587045611092887 48.938129728587505 37.9, 2.3587564191246613 48.93813090532335 37.9, 2.3588259553325677 48.938137572307696 32.8, 2.3587989899385637 48.93822106142358 32.8, 2.358864442418887 48.938226807254324 32.8, 2.358859793318892 48.93827174655911 32.8, 2.3587356577322867 48.93826478749264 32.8, 2.3587358018427214 48.93825309757853 32.8, 2.3587359237822696 48.93824320611264 32.8, 2.3587392523499795 48.93819466261178 32.8, 2.3586218642409946 48.93819403451049 37.9, 2.358340623320995 48.938197025642175 39.1, 2.3583358055175085 48.93792361761327 37.7, 2.35823336613997 48.93792846485857 37.9, 2.35823275677521 48.93819914598358 37.8, 2.358270920694243 48.93820384673919 37.8, 2.35827982103772 48.93825695212048 37.7, 2.3585446825305296 48.938253873472156 37.5, 2.358541220711983 48.9383132076542 37.5, 2.358588618060021 48.93834403694189 37.5, 2.3586129216333385 48.93836574979897 37.5, 2.35863728066268 48.938382966530426 37.5, 2.358732807299459 48.93838527622011 37.5, 2.35873889909882 48.93833404965913 34.8, 2.35866966197695 48.93830310357454 32.9, 2.3587273680830125 48.93827283669249 32.9, 2.3588569746921575 48.93827892574944 32.9, 2.3588591633072853 48.9384336141978 32.6, 2.3588222200592424 48.938440610844665 43.2, 2.358816372179076 48.93847205447719 49.1)))",
                    "MULTIPOLYGON Z (((2.3591313777310043 48.93816618426028 40.7, 2.359140483025784 48.938424327281645 40.7, 2.3590093780685892 48.93842902192096 41.9, 2.3590071647950417 48.93816552004427 41.5, 2.3591313777310043 48.93816618426028 40.7)))",
                ]),
            },
            crs=TEST_CRS
        ),
        # Test 2 : schools_buildings_expected
        gpd.GeoDataFrame(
            {
                "cleabs_bat": [  # seuls les batiments majoritairement dans la zone d'education sont affectés
                    "BATIMENT0000000002632136",
                    "BATIMENT0000002011629925",
                    "BATIMENT0000002011629926",
                ],
                "cleabs_grande_zone": [ # tous les batiments sont affectés a la plus grande zone
                    "SURFACTI0000000002555603",  
                    "SURFACTI0000000002555603",
                    "SURFACTI0000000002555603",
                ],
                "identifiant_de_l_etablissement": [ # tous les batiments sont affectés au même établissement
                    "0930419A",
                    "0930419A",
                    "0930419A",
                ],
                "geometry": map(from_wkt, [
                    "MULTIPOLYGON Z (((2.359140483025784 48.938424327281645 40.7, 2.3591432928827913 48.938528659162564 40.6, 2.3591064160798787 48.93853026055259 40.6, 2.3590149287174564 48.93853246917995 40.7, 2.3590093780685892 48.93842902192096 41.9, 2.359140483025784 48.938424327281645 40.7)))",
                    "MULTIPOLYGON Z (((2.358816372179076 48.93847205447719 49.1, 2.3586988725821794 48.93848041869137 48.2, 2.3586399786369827 48.93849629066672 48.4, 2.3585740268705533 48.938531009792044 48.4, 2.358561064488982 48.938475184859676 48.2, 2.3584748042524324 48.93849630599728 48.2, 2.3584597561367726 48.938498923303875 45.8, 2.3583970333303856 48.9384931918671 45.8, 2.3583371403403444 48.938479381996885 45.8, 2.3583155446133404 48.93845948214944 48.2, 2.3583105505717237 48.93842168551187 48.6, 2.3583407576946493 48.93840745869391 48.9, 2.358337172991594 48.93836607246685 48.9, 2.358301860934578 48.938351494884245 48.9, 2.3582397378185496 48.93840781712984 48.8, 2.3582099189767667 48.93839057108267 48.8, 2.3582075884153073 48.93835818440028 48.8, 2.3581723984468757 48.9383337153149 48.8, 2.3581204625700467 48.93833883289493 48.8, 2.3581441998511186 48.93829579440583 46.4, 2.358198954401217 48.93828349764061 46.5, 2.358192617671525 48.93824389523473 46.6, 2.358166893875688 48.93822667110132 46.6, 2.3581190530419343 48.93823181060923 46.6, 2.3580924859403027 48.93828292749232 47.2, 2.3580703244454577 48.938308888025155 48.1, 2.358040283767613 48.93830962641552 48.5, 2.3580145155981413 48.93829599914673 48.5, 2.358012307239747 48.93825372099266 48.4, 2.3579768510691177 48.93825083322619 48.4, 2.3579801359518027 48.93820588664328 48.4, 2.3579475762572932 48.93818952512878 48.4, 2.357980890646759 48.93814473940027 48.4, 2.358051936014357 48.93813972423057 48.8, 2.3580539224328514 48.938089374984955 48.8, 2.3580895782356492 48.93807607669261 48.8, 2.358087369825583 48.93803379853131 48.8, 2.358113504056514 48.938017751386056 48.8, 2.358111273437176 48.937977271671585 48.8, 2.358142878615212 48.93796035453457 48.8, 2.3581392830047436 48.93791986750883 48.9, 2.3580791244225936 48.93792763888777 49, 2.3580434687188694 48.93794093717883 48.8, 2.3579998340306294 48.9379371063291 48.8, 2.357997670091799 48.93789123126311 48.8, 2.358033192603387 48.93788872367798 49, 2.3580579950998173 48.93786997155852 49.1, 2.35807957938688 48.93789077068766 49.1, 2.3581193743398066 48.93787389741728 48.6, 2.3581672037492027 48.937869657131984 48.5, 2.358196090000368 48.93785182613606 48.5, 2.358203635989553 48.937793413090006 46.1, 2.3582295703706793 48.937793551957 46, 2.3587825928174926 48.93777942541555 44.1, 2.358927312582319 48.93777750170296 44.1, 2.3589271241882006 48.93779278852075 44.1, 2.3591168657544177 48.93779290394305 41.7, 2.3591313777310043 48.93816618426028 41.4, 2.3590071647950417 48.93816552004427 41.2, 2.3590045858809994 48.93793169251081 41.1, 2.35892672711499 48.93793577251835 38.1, 2.3588256416561584 48.937941526794916 38.3, 2.358824043924461 48.937960403206034 38.2, 2.358630184657995 48.93796206385684 38.2, 2.35849497481424 48.93796763524758 38.6, 2.3584959969752965 48.93810613040486 38.5, 2.358637954447124 48.9381068901038 37.9, 2.358639119855831 48.938123083444715 37.9, 2.3587045611092887 48.938129728587505 37.9, 2.3587564191246613 48.93813090532335 37.9, 2.3588259553325677 48.938137572307696 32.8, 2.3587989899385637 48.93822106142358 32.8, 2.358864442418887 48.938226807254324 32.8, 2.358859793318892 48.93827174655911 32.8, 2.3587356577322867 48.93826478749264 32.8, 2.3587358018427214 48.93825309757853 32.8, 2.3587359237822696 48.93824320611264 32.8, 2.3587392523499795 48.93819466261178 32.8, 2.3586218642409946 48.93819403451049 37.9, 2.358340623320995 48.938197025642175 39.1, 2.3583358055175085 48.93792361761327 37.7, 2.35823336613997 48.93792846485857 37.9, 2.35823275677521 48.93819914598358 37.8, 2.358270920694243 48.93820384673919 37.8, 2.35827982103772 48.93825695212048 37.7, 2.3585446825305296 48.938253873472156 37.5, 2.358541220711983 48.9383132076542 37.5, 2.358588618060021 48.93834403694189 37.5, 2.3586129216333385 48.93836574979897 37.5, 2.35863728066268 48.938382966530426 37.5, 2.358732807299459 48.93838527622011 37.5, 2.35873889909882 48.93833404965913 34.8, 2.35866966197695 48.93830310357454 32.9, 2.3587273680830125 48.93827283669249 32.9, 2.3588569746921575 48.93827892574944 32.9, 2.3588591633072853 48.9384336141978 32.6, 2.3588222200592424 48.938440610844665 43.2, 2.358816372179076 48.93847205447719 49.1)))",
                    "MULTIPOLYGON Z (((2.3591313777310043 48.93816618426028 40.7, 2.359140483025784 48.938424327281645 40.7, 2.3590093780685892 48.93842902192096 41.9, 2.3590071647950417 48.93816552004427 41.5, 2.3591313777310043 48.93816618426028 40.7)))",

                ]),
            },
            crs=TEST_CRS
        ),
    ),

    # Test 3
    # Un batiment overlap trois zones et un autre deux zones
    # 2 etablissements pour 3 zones
    # La plus petite zone est contenue completement dans une grande et les deux grandes zones sont adjacentes
    (
        # Test 3 : schools_establishments
        gpd.GeoDataFrame(
            {       
                "identifiant_de_l_etablissement": [
                    "0931144N",
                    "0930297T"
                ],
                "nombre_d_eleves": [
                    100,
                    200,
                ],
                "geometry": map(from_wkt, [
                    "POINT (2.345992181917522 48.90421506495199)",
                    "POINT (2.3460925621949777 48.904151761795916)"
                ]),
            },
            crs=TEST_CRS
        ),
        # Test 3 : educational_zones
        gpd.GeoDataFrame(
            {
                "cleabs": [
                    "SURFACTI0000000002555878",  # grande zone
                    "SURFACTI0000000002555879",  # grande zone
                    "SURFACTI0000000244244919",  # petite zone inclue dans SURFACTI0000000002555879

                ],
                "identifiants_sources": [
                    "MEN:0931144N",
                    "MEN:0930475L",
                    "MEN:0930297T",
                ],
                "geometry": map(from_wkt, [
                    "MULTIPOLYGON (((2.3462238668673625 48.90401574319931, 2.346280706496467 48.904052025954456, 2.3463780057061894 48.90412540130655, 2.3462185635931854 48.90422075759808, 2.3466810967104745 48.90454073874077, 2.346708694595323 48.904515708517884, 2.34680304139706 48.904607053631835, 2.3468222628599262 48.904597266016005, 2.3468547416275385 48.90461812731351, 2.346880445071271 48.9046353544078, 2.346871955846663 48.90465958955308, 2.346857953806438 48.904688291198205, 2.346644983613485 48.904809436172314, 2.3465404426980636 48.904878112931435, 2.346500691796947 48.904893184368724, 2.34641959082647 48.904833387249894, 2.34617569038532 48.904701655837094, 2.346014831473 48.904583867029906, 2.345830862836998 48.90445965658843, 2.3457212756639145 48.904387113004134, 2.3456766450344606 48.90435629256786, 2.3462238668673625 48.90401574319931)))",
                    "MULTIPOLYGON (((2.3456766450344606 48.90435629256786, 2.3457212756639145 48.904387113004134, 2.345830862836998 48.90445965658843, 2.346014831473 48.904583867029906, 2.34617569038532 48.904701655837094, 2.34641959082647 48.904833387249894, 2.346500691796947 48.904893184368724, 2.3464138951768923 48.904961058511866, 2.346247539680913 48.90506357155579, 2.3463262693369655 48.90531221135755, 2.346438293970197 48.90540814971941, 2.3464001890398554 48.90540074730349, 2.346397311852758 48.90552123938439, 2.3464412777478123 48.90560511527456, 2.346142724443771 48.905697014308245, 2.3460867501699343 48.90570030598822, 2.3458276762520827 48.90579871493845, 2.345808499365884 48.90580490538454, 2.3457947789830937 48.90581112562951, 2.3457056924957898 48.9058439135594, 2.3456286795652606 48.905892954989596, 2.345383147640288 48.90589071406343, 2.345390556357116 48.90584399035187, 2.3453824098036167 48.905732431188625, 2.3455283598604875 48.90573412805228, 2.3455292530851657 48.90566308730979, 2.345512883608285 48.90566299786674, 2.3453846447322166 48.90566319640211, 2.3453906073584205 48.90540602580465, 2.345398506530754 48.90521181757869, 2.345451763408389 48.905207612059826, 2.346055446196146 48.905151554852836, 2.3461059747397637 48.90514733414782, 2.346009959023647 48.90508026084469, 2.3457569957408047 48.904909808697475, 2.3455689794908485 48.90478197853534, 2.3455331058619606 48.904814157774176, 2.3453377001548543 48.90484006928934, 2.3451764873069925 48.904858972923414, 2.3451519948040134 48.90474552565122, 2.3451197994767057 48.9047021826275, 2.3456766450344606 48.90435629256786)))",
                    "MULTIPOLYGON (((2.3457759836288323 48.904810088739225, 2.3457077785914504 48.90480971618531, 2.3457083437587936 48.90476475365168, 2.3457765487372657 48.90476512620527, 2.3457759836288323 48.904810088739225)))",           
                ]),
            },
            crs=TEST_CRS
        ), 
        # Test 3 : buildings
        gpd.GeoDataFrame(
            {
                "cleabs": [
                    "BATIMENT0000000246488966",  # overlap les 3 zones
                    "BATIMENT0000000246489004",  # dans la zone SURFACTI0000000002555878
                    "BATIMENT0000000246489005",  # overlap les deux grandes zones
                    "BATIMENT0000000246488967",  # en dehors de toutes les zones
                    "BATIMENT0000002245453164",  # dans la zone SURFACTI0000000002555879
                ],
                "geometry": map(from_wkt, [
                    "MULTIPOLYGON Z (((2.3454615095904945 48.904758009178884 49, 2.345427701119705 48.90473444229955 49, 2.3453262758910114 48.90466374160128 49, 2.345304642616251 48.904648335043674 49, 2.3453403805561557 48.90462694687769 49, 2.3453761297757336 48.90460465944982 49, 2.3455782571796036 48.90447806158049 49, 2.34574187264105 48.904376433760014 49, 2.3457459988170246 48.90437375836013 49, 2.346005856663722 48.90421240187775 49, 2.3461845996073873 48.904100963591794 49, 2.346345450664106 48.90400201777372 49, 2.3464320651238277 48.90394853164354 49, 2.346547550793247 48.903877216701815 49, 2.346632800762622 48.903823722978466 49, 2.346650669180325 48.90381302869066 49, 2.346654772691371 48.903812151761215 49, 2.34665751212757 48.903811267391006 49, 2.3466629797130487 48.903810397901935 49, 2.346668447298346 48.90380952841263 49, 2.346675267671678 48.9038095656151 49, 2.346680712684019 48.90381049462837 49, 2.346686135124077 48.90381322214452 49, 2.346707779746518 48.903827729212836 49, 2.34674698808505 48.90385582176678 49, 2.3467740326235926 48.90387485483862 49, 2.346775374130563 48.90387666078099 49, 2.3467767156376267 48.903878466723334 49, 2.3467766592141794 48.90388296298094 49, 2.3467766366447975 48.90388476148398 49, 2.3467353983541024 48.90390971734004 49, 2.3465800385076334 48.904005995702235 49, 2.346395795240552 48.904121001818716 49, 2.3463849729103234 48.90411374825882 49, 2.3462186087708017 48.90421716059332 49, 2.346345714860563 48.90430688628142 49, 2.3464890549915527 48.904407492151975 49, 2.3466743101011405 48.904538003785746 49, 2.346710092546434 48.90451301820498 49, 2.3468061081183906 48.904580090981725 49, 2.34688319582997 48.90463357078218 49, 2.346887242987071 48.90463719009998 49, 2.3468899486140486 48.90463900347785 49, 2.3468912675789837 48.90464260791948 49, 2.3468925752612493 48.90464711161195 49, 2.3468938716609085 48.904652514555295 49, 2.346892451149836 48.904657003371796 49, 2.346891030638517 48.90466149218826 49, 2.346886881932676 48.90466596612864 49, 2.3468840973233758 48.90467044750695 49, 2.3467809775256074 48.904734635668675 49, 2.346672389784474 48.90479969322682 49, 2.3467194222958567 48.90485660643041 49, 2.3467153074176017 48.904858382611906 49, 2.346664250328125 48.90479605158064 49, 2.3465583679400526 48.90486292241428 49, 2.3465569925491017 48.904863814223184 49, 2.3465542756332924 48.90486290008886 49, 2.3465434192599455 48.9048583443003 49, 2.346531210075628 48.904852881817966 49, 2.346517648081406 48.90484651264143 49, 2.346502767147372 48.90483653901807 49, 2.3464311020540674 48.90478578650799 49, 2.3463621314221488 48.90473774659307 49, 2.346508993171547 48.904666602948296 49, 2.3466078177038856 48.9046185792094 49, 2.3465591505089463 48.904583240530144 49, 2.3465303916246447 48.90459207675865 49, 2.3465046092913506 48.904581144344995 49, 2.3464469221386555 48.904612305532254 49, 2.3463953349150546 48.904592239165545 49, 2.3463739271895645 48.90455884778169 49, 2.346419292321657 48.90453121664222 49, 2.346453191432774 48.90454758923854 49, 2.346482074494739 48.90452886126771 49, 2.3463373812445982 48.90442734870466 49, 2.346202158112716 48.90433218283631 49, 2.3461237300523763 48.9042768966338 49, 2.3458611440670474 48.904438238462966 49, 2.345830896740459 48.90445695883556 49, 2.34567965978118 48.904550560579146 49, 2.345580664939091 48.90461207231742 49, 2.3458578861787966 48.90480603949928 49, 2.3460985949345323 48.90497462592601 49, 2.346003714697748 48.905034361829976 49, 2.3458401043371393 48.90491835642902 49, 2.345652133069473 48.90478692939568 49, 2.3454857960759425 48.904670908580215 49, 2.3454541617661913 48.904691419901155 49, 2.345500134035819 48.90472404636612 49, 2.3455082507858944 48.904729486593055 49, 2.3454615095904945 48.904758009178884 49)))",
                    "MULTIPOLYGON Z (((2.3459904502563758 48.90446142739092 42.4, 2.3460303365479835 48.90443556510515 42.4, 2.3460451268972737 48.90445273279871 42.4, 2.346054528672546 48.904464475194416 42.4, 2.346059860770317 48.904474396744995 42.4, 2.3460705023779145 48.904496038347126 42.4, 2.34599351438195 48.90454328157061 42.4, 2.3459421081894773 48.904508826992696 42.4, 2.3459792211626076 48.904486546831194 42.4, 2.3459481182188564 48.90446479349156 42.4, 2.3459728639480613 48.904449640299724 42.4, 2.3459904502563758 48.90446142739092 42.4)))",
                    "MULTIPOLYGON Z (((2.3459777523416694 48.904603449447904 42.6, 2.3460093750935496 48.90458383723791 42.6, 2.3461040370930886 48.90465000387423 42.6, 2.346178418581266 48.90470167072934 42.6, 2.34614543172301 48.904721275535366 42.6, 2.3461170341728383 48.904701335638784 42.6, 2.346097789945747 48.90471292164205 42.6, 2.3459869055621336 48.90463497536558 42.6, 2.34600478568919 48.90462338193122 42.6, 2.3459777523416694 48.904603449447904 42.6)))",
                    "MULTIPOLYGON Z (((2.3465569925491017 48.904863814223184 44.5, 2.3465583679400526 48.90486292241428 44.5, 2.346664250328125 48.90479605158064 44.5, 2.3467153074176017 48.904858382611906 44.5, 2.3467043494557505 48.90486192009431 44.5, 2.346690652001343 48.904866341945876 44.5, 2.3466769658312354 48.90486986454517 44.5, 2.3466632909461387 48.90487248789219 44.5, 2.34664689914164 48.904874197105435 44.5, 2.3466332581160403 48.90487412269696 44.5, 2.3466182529879256 48.90487404084583 44.5, 2.346600530942707 48.904873044859556 44.5, 2.3465882765963153 48.90487117938586 44.5, 2.346576033539174 48.90486841466023 44.5, 2.3465651432970995 48.90486655662572 44.5, 2.3465569925491017 48.904863814223184 44.5)))",
                    "MULTIPOLYGON Z (((2.346331703207573 48.905314039635705 -1000, 2.34614088538911 48.90530040776942 -1000, 2.3461376601361748 48.90533995988838 -1000, 2.3460108539624267 48.90533477103921 -1000, 2.3460031408186475 48.90540577456637 -1000, 2.3460140424516664 48.905406733400845 -1000, 2.3460065326717037 48.905461550421016 -1000, 2.346145582328224 48.905469504043545 -1000, 2.346144150434364 48.90547489209795 -1000, 2.3461659650305378 48.90547591048999 -1000, 2.3461689530643492 48.90545524262882 -1000, 2.3463966703963237 48.90546367993073 -1000, 2.346399951917782 48.9054196315582 -1000, 2.3463126597351276 48.90541825588708 -1000, 2.346312840423704 48.905403867883635 -1000, 2.3463564921485314 48.905404106101976 -1000, 2.3463582063246657 48.905376236788676 -1000, 2.3464004826193277 48.90537736679717 -1000, 2.346331703207573 48.905314039635705 -1000)))",
                ]),
            },
            crs=TEST_CRS
        ),
        # Test 3 : schools_buildings_expected
        gpd.GeoDataFrame(
            {
                "cleabs_bat": [
                    "BATIMENT0000000246488966",  # overlap les 3 zones
                    "BATIMENT0000000246489004",  # dans la zone SURFACTI0000000002555878
                    "BATIMENT0000000246489005",  # overlap les deux grandes zones
                    "BATIMENT0000002245453164",  # dans la zone SURFACTI0000000002555879
                ],
                "cleabs_grande_zone": [ 
                    "SURFACTI0000000002555878",
                    "SURFACTI0000000002555878",
                    "SURFACTI0000000002555879",
                    "SURFACTI0000000002555879",
                ],
                "identifiant_de_l_etablissement": [
                    "0931144N",
                    "0931144N",
                    "0930297T",
                    "0930297T",
                ],
                "geometry": map(from_wkt, [
                    "MULTIPOLYGON Z (((2.3454615095904945 48.904758009178884 49, 2.345427701119705 48.90473444229955 49, 2.3453262758910114 48.90466374160128 49, 2.345304642616251 48.904648335043674 49, 2.3453403805561557 48.90462694687769 49, 2.3453761297757336 48.90460465944982 49, 2.3455782571796036 48.90447806158049 49, 2.34574187264105 48.904376433760014 49, 2.3457459988170246 48.90437375836013 49, 2.346005856663722 48.90421240187775 49, 2.3461845996073873 48.904100963591794 49, 2.346345450664106 48.90400201777372 49, 2.3464320651238277 48.90394853164354 49, 2.346547550793247 48.903877216701815 49, 2.346632800762622 48.903823722978466 49, 2.346650669180325 48.90381302869066 49, 2.346654772691371 48.903812151761215 49, 2.34665751212757 48.903811267391006 49, 2.3466629797130487 48.903810397901935 49, 2.346668447298346 48.90380952841263 49, 2.346675267671678 48.9038095656151 49, 2.346680712684019 48.90381049462837 49, 2.346686135124077 48.90381322214452 49, 2.346707779746518 48.903827729212836 49, 2.34674698808505 48.90385582176678 49, 2.3467740326235926 48.90387485483862 49, 2.346775374130563 48.90387666078099 49, 2.3467767156376267 48.903878466723334 49, 2.3467766592141794 48.90388296298094 49, 2.3467766366447975 48.90388476148398 49, 2.3467353983541024 48.90390971734004 49, 2.3465800385076334 48.904005995702235 49, 2.346395795240552 48.904121001818716 49, 2.3463849729103234 48.90411374825882 49, 2.3462186087708017 48.90421716059332 49, 2.346345714860563 48.90430688628142 49, 2.3464890549915527 48.904407492151975 49, 2.3466743101011405 48.904538003785746 49, 2.346710092546434 48.90451301820498 49, 2.3468061081183906 48.904580090981725 49, 2.34688319582997 48.90463357078218 49, 2.346887242987071 48.90463719009998 49, 2.3468899486140486 48.90463900347785 49, 2.3468912675789837 48.90464260791948 49, 2.3468925752612493 48.90464711161195 49, 2.3468938716609085 48.904652514555295 49, 2.346892451149836 48.904657003371796 49, 2.346891030638517 48.90466149218826 49, 2.346886881932676 48.90466596612864 49, 2.3468840973233758 48.90467044750695 49, 2.3467809775256074 48.904734635668675 49, 2.346672389784474 48.90479969322682 49, 2.3467194222958567 48.90485660643041 49, 2.3467153074176017 48.904858382611906 49, 2.346664250328125 48.90479605158064 49, 2.3465583679400526 48.90486292241428 49, 2.3465569925491017 48.904863814223184 49, 2.3465542756332924 48.90486290008886 49, 2.3465434192599455 48.9048583443003 49, 2.346531210075628 48.904852881817966 49, 2.346517648081406 48.90484651264143 49, 2.346502767147372 48.90483653901807 49, 2.3464311020540674 48.90478578650799 49, 2.3463621314221488 48.90473774659307 49, 2.346508993171547 48.904666602948296 49, 2.3466078177038856 48.9046185792094 49, 2.3465591505089463 48.904583240530144 49, 2.3465303916246447 48.90459207675865 49, 2.3465046092913506 48.904581144344995 49, 2.3464469221386555 48.904612305532254 49, 2.3463953349150546 48.904592239165545 49, 2.3463739271895645 48.90455884778169 49, 2.346419292321657 48.90453121664222 49, 2.346453191432774 48.90454758923854 49, 2.346482074494739 48.90452886126771 49, 2.3463373812445982 48.90442734870466 49, 2.346202158112716 48.90433218283631 49, 2.3461237300523763 48.9042768966338 49, 2.3458611440670474 48.904438238462966 49, 2.345830896740459 48.90445695883556 49, 2.34567965978118 48.904550560579146 49, 2.345580664939091 48.90461207231742 49, 2.3458578861787966 48.90480603949928 49, 2.3460985949345323 48.90497462592601 49, 2.346003714697748 48.905034361829976 49, 2.3458401043371393 48.90491835642902 49, 2.345652133069473 48.90478692939568 49, 2.3454857960759425 48.904670908580215 49, 2.3454541617661913 48.904691419901155 49, 2.345500134035819 48.90472404636612 49, 2.3455082507858944 48.904729486593055 49, 2.3454615095904945 48.904758009178884 49)))",
                    "MULTIPOLYGON Z (((2.3459904502563758 48.90446142739092 42.4, 2.3460303365479835 48.90443556510515 42.4, 2.3460451268972737 48.90445273279871 42.4, 2.346054528672546 48.904464475194416 42.4, 2.346059860770317 48.904474396744995 42.4, 2.3460705023779145 48.904496038347126 42.4, 2.34599351438195 48.90454328157061 42.4, 2.3459421081894773 48.904508826992696 42.4, 2.3459792211626076 48.904486546831194 42.4, 2.3459481182188564 48.90446479349156 42.4, 2.3459728639480613 48.904449640299724 42.4, 2.3459904502563758 48.90446142739092 42.4)))",
                    "MULTIPOLYGON Z (((2.3459777523416694 48.904603449447904 42.6, 2.3460093750935496 48.90458383723791 42.6, 2.3461040370930886 48.90465000387423 42.6, 2.346178418581266 48.90470167072934 42.6, 2.34614543172301 48.904721275535366 42.6, 2.3461170341728383 48.904701335638784 42.6, 2.346097789945747 48.90471292164205 42.6, 2.3459869055621336 48.90463497536558 42.6, 2.34600478568919 48.90462338193122 42.6, 2.3459777523416694 48.904603449447904 42.6)))",
                    "MULTIPOLYGON Z (((2.346331703207573 48.905314039635705 -1000, 2.34614088538911 48.90530040776942 -1000, 2.3461376601361748 48.90533995988838 -1000, 2.3460108539624267 48.90533477103921 -1000, 2.3460031408186475 48.90540577456637 -1000, 2.3460140424516664 48.905406733400845 -1000, 2.3460065326717037 48.905461550421016 -1000, 2.346145582328224 48.905469504043545 -1000, 2.346144150434364 48.90547489209795 -1000, 2.3461659650305378 48.90547591048999 -1000, 2.3461689530643492 48.90545524262882 -1000, 2.3463966703963237 48.90546367993073 -1000, 2.346399951917782 48.9054196315582 -1000, 2.3463126597351276 48.90541825588708 -1000, 2.346312840423704 48.905403867883635 -1000, 2.3463564921485314 48.905404106101976 -1000, 2.3463582063246657 48.905376236788676 -1000, 2.3464004826193277 48.90537736679717 -1000, 2.346331703207573 48.905314039635705 -1000)))",
                ]),
            },
            crs=TEST_CRS
        ),
    ),

    # Test 4 (#TODO) : 
    # Une zone est partagée entre trois établissements
    (
        # Test 4 : schools_establishments
        gpd.GeoDataFrame(
            {       
                "identifiant_de_l_etablissement": [
                    "0930324X",
                    "0930202P",
                    "0930472H",
                ],
                "nombre_d_eleves": [
                    100,
                    200,
                    300,
                ],
                "geometry": map(from_wkt, [
                    "POINT (2.3807172445672875 48.964301889943414)",
                    "POINT (2.3807172445672875 48.964301889943414)",
                    "POINT (2.3807172445672875 48.964301889943414)",
                ]),
            },
            crs=TEST_CRS
        ),
        # Test 4 : educational_zones
        gpd.GeoDataFrame(
            {
                "cleabs": [
                    "SURFACTI0000000002555427"
                ],
                "identifiants_sources": [
                    "MEN:0930324X/MEN:0930472H/MEN:0930202P"
                ],
                "geometry": map(from_wkt, [
                    "MULTIPOLYGON (((2.3785319834385956 48.96396411406555, 2.3789070450756133 48.96400742313108, 2.37908294654826 48.96403081552934, 2.3793829407440787 48.96407013735816, 2.3797265507313914 48.96411687811568, 2.37971945422362 48.96413932290777, 2.3798721616929726 48.9641607956509, 2.3799153337569185 48.96409087661901, 2.3800409745534266 48.96409152621226, 2.3801172907445696 48.964105409619634, 2.380194919039101 48.96412379605894, 2.380270030434108 48.96412418424344, 2.3803395827275695 48.96413263699459, 2.3803764127342375 48.96413642433718, 2.3804418573589277 48.964145755064536, 2.3806478152874044 48.96416840117757, 2.38074475593722 48.96417070032238, 2.380943785681008 48.964545819912296, 2.3805830123575036 48.96456374071514, 2.378758376422568 48.96456239565455, 2.378527534688775 48.96456479662677, 2.3782027411031166 48.96454332929956, 2.3782397648115863 48.96453093162594, 2.3782687020033624 48.964509499419755, 2.3784704325740718 48.96408609444888, 2.3785319834385956 48.96396411406555)))"
                ]),
            },
            crs=TEST_CRS
        ), 
        # Test 4 : buildings
        gpd.GeoDataFrame(
            {
                "cleabs": [
                    "BATIMENT0000000229478053",
                    "BATIMENT0000000244177265",
                    "BATIMENT0000000244177258",
                    "BATIMENT0000000244177269",
                    "BATIMENT0000000244177262",
                    "BATIMENT0000000244177266",
                ],
                "geometry": map(from_wkt, [
                    "MULTIPOLYGON Z (((2.378392773560306 48.96441302254565 45.8, 2.378394816835239 48.96447058576188 45.9, 2.378469907218387 48.964472773481745 45.9, 2.3784692617784704 48.96441251973267 45.9, 2.378392773560306 48.96441302254565 45.8)))",
                    "MULTIPOLYGON Z (((2.380644955417257 48.9641791775248 52.4, 2.380789137803992 48.964457793326595 52.4, 2.3807477178543066 48.96449534835015 52.4, 2.38072424438078 48.96451680936407 52.4, 2.37946230984454 48.96451478242312 52.4, 2.379436576738563 48.964496664072016 52.4, 2.3794353183972476 48.964487664964146 52.4, 2.3792181659488683 48.964487440322586 52.4, 2.3792180371076856 48.96449823077145 52.4, 2.3791905304089878 48.964514275052395 52.4, 2.3787452891748804 48.96451466709544 52.4, 2.378619636624913 48.964514915349014 52.4, 2.3786217983730684 48.964562587312415 52.4, 2.3784947692843907 48.96456372756285 52.4, 2.3784963816737177 48.96442884696229 52.4, 2.378616571338229 48.96442857053279 52.4, 2.3786136549736647 48.96410122481919 52.4, 2.378740682929729 48.964100084442315 52.4, 2.378739503085527 48.964427408928564 52.4, 2.3791506018339246 48.96442684015637 52.4, 2.3791497623231335 48.964382772083326 52.4, 2.3795048683092372 48.9643819122043 52.4, 2.3795056759256683 48.96442867788735 52.4, 2.379916796125025 48.96442630808035 52.4, 2.379920710603935 48.964098098500706 52.4, 2.380042211545123 48.96410232372607 52.4, 2.380043717622021 48.96443415836548 52.4, 2.3806159440338552 48.96443621595584 52.4, 2.380638008997513 48.964418344725274 52.4, 2.3805298540025097 48.96421095636075 52.4, 2.3803484886157764 48.964187537862536 52.4, 2.380361315433013 48.964142641148676 52.4, 2.3803790368922546 48.96414543049438 52.4, 2.380644955417257 48.9641791775248 52.4)))",
                    "MULTIPOLYGON Z (((2.3790031889299876 48.963962058774136 45.4, 2.3790113613933737 48.96396389961426 45.4, 2.3790754506374276 48.96397232481247 45.4, 2.3792049841090046 48.963990081380075 45.4, 2.379210436004494 48.963991008862855 45.4, 2.3792390718793883 48.96399475413771 45.4, 2.3793427008858825 48.964008779420425 45.4, 2.3794190597018745 48.96401906645529 45.4, 2.3794777079079945 48.96402566476036 45.4, 2.379607241649842 48.964043420892594 45.4, 2.379744980167797 48.96406032006111 45.4, 2.3797278412977616 48.964123179610354 45.4, 2.3789206264678175 48.96401378829139 45.4, 2.3789390889688207 48.963954532741724 45.4, 2.3790031889299876 48.963962058774136 45.4)))",
                    "MULTIPOLYGON Z (((2.3793816122079203 48.9642958447167 46.6, 2.3792819293173384 48.96429442953709 46.6, 2.379273086728766 48.96411992734947 46.6, 2.3793809954554046 48.96411868732932 46.6, 2.3793816122079203 48.9642958447167 46.6)))",
                    "MULTIPOLYGON Z (((2.379881742781935 48.964159046675704 45.5, 2.3797317129987516 48.96414208409404 45.5, 2.379753099035774 48.964066656872895 45.5, 2.3799071826910962 48.964087237431784 45.5, 2.379881742781935 48.964159046675704 45.5)))",
                    "MULTIPOLYGON Z (((2.3803790368922546 48.96414543049438 49.3, 2.380361315433013 48.964142641148676 49.3, 2.3802658691374887 48.9641295582978 49.3, 2.3802687290834816 48.96411878195911 49.3, 2.3802891925711287 48.96412068622861 49.3, 2.380300471557294 48.964091068937876 49.3, 2.3803154831092046 48.96409204576981 49.3, 2.3803169345115305 48.96408485919069 49.3, 2.380336032326827 48.96408675639533 49.3, 2.380338924407806 48.964073282440964 49.3, 2.380393486526397 48.96407895992319 49.3, 2.3803790368922546 48.96414543049438 49.3)))",
                ]),
            },
            crs=TEST_CRS
        ),
        # Test 4 : schools_buildings_expected
        gpd.GeoDataFrame(
            {
                "cleabs_bat": [
                    "BATIMENT0000000229478053",
                    "BATIMENT0000000244177265",
                    "BATIMENT0000000244177269",
                ],
                "cleabs_grande_zone": [ 
                    "SURFACTI0000000002555427",
                    "SURFACTI0000000002555427",
                    "SURFACTI0000000002555427"
                ],
                "identifiant_de_l_etablissement": [
                    "0930472H",
                    "0930472H",
                    "0930472H",
                ],
                "geometry": map(from_wkt, [
                    "MULTIPOLYGON Z (((2.378392773560306 48.96441302254565 45.8, 2.378394816835239 48.96447058576188 45.9, 2.378469907218387 48.964472773481745 45.9, 2.3784692617784704 48.96441251973267 45.9, 2.378392773560306 48.96441302254565 45.8)))",
                    "MULTIPOLYGON Z (((2.380644955417257 48.9641791775248 52.4, 2.380789137803992 48.964457793326595 52.4, 2.3807477178543066 48.96449534835015 52.4, 2.38072424438078 48.96451680936407 52.4, 2.37946230984454 48.96451478242312 52.4, 2.379436576738563 48.964496664072016 52.4, 2.3794353183972476 48.964487664964146 52.4, 2.3792181659488683 48.964487440322586 52.4, 2.3792180371076856 48.96449823077145 52.4, 2.3791905304089878 48.964514275052395 52.4, 2.3787452891748804 48.96451466709544 52.4, 2.378619636624913 48.964514915349014 52.4, 2.3786217983730684 48.964562587312415 52.4, 2.3784947692843907 48.96456372756285 52.4, 2.3784963816737177 48.96442884696229 52.4, 2.378616571338229 48.96442857053279 52.4, 2.3786136549736647 48.96410122481919 52.4, 2.378740682929729 48.964100084442315 52.4, 2.378739503085527 48.964427408928564 52.4, 2.3791506018339246 48.96442684015637 52.4, 2.3791497623231335 48.964382772083326 52.4, 2.3795048683092372 48.9643819122043 52.4, 2.3795056759256683 48.96442867788735 52.4, 2.379916796125025 48.96442630808035 52.4, 2.379920710603935 48.964098098500706 52.4, 2.380042211545123 48.96410232372607 52.4, 2.380043717622021 48.96443415836548 52.4, 2.3806159440338552 48.96443621595584 52.4, 2.380638008997513 48.964418344725274 52.4, 2.3805298540025097 48.96421095636075 52.4, 2.3803484886157764 48.964187537862536 52.4, 2.380361315433013 48.964142641148676 52.4, 2.3803790368922546 48.96414543049438 52.4, 2.380644955417257 48.9641791775248 52.4)))",
                    "MULTIPOLYGON Z (((2.3793816122079203 48.9642958447167 46.6, 2.3792819293173384 48.96429442953709 46.6, 2.379273086728766 48.96411992734947 46.6, 2.3793809954554046 48.96411868732932 46.6, 2.3793816122079203 48.9642958447167 46.6)))",
                ]),
            },
            crs=TEST_CRS
        ),
    ),

    # Test 5 (#TODO) : 
    # Deux etablissements pour deux zones
    # Une des zones est inclue dans l'autre
    #  (
    #     # Test 5 : schools_establishments
    #     gpd.GeoDataFrame(
    #         {       
    #             "identifiant_de_l_etablissement": [

    #             ],
    #             "geometry": map(from_wkt, [

    #             ]),
    #         },
    #         crs=TEST_CRS
    #     ),
    #     # Test 5 : educational_zones
    #     gpd.GeoDataFrame(
    #         {
    #             "cleabs": [


    #             ],
    #             "identifiants_sources": [

    #             ],
    #             "geometry": map(from_wkt, [
          
    #             ]),
    #         },
    #         crs=TEST_CRS
    #     ), 
    #     # Test 5 : buildings
    #     gpd.GeoDataFrame(
    #         {
    #             "cleabs": [

    #             ],
    #             "geometry": map(from_wkt, [

    #             ]),
    #         },
    #         crs=TEST_CRS
    #     ),
    #     # Test 5 : schools_buildings_expected
    #     gpd.GeoDataFrame(
    #         {
    #             "cleabs_bat": [

    #             ],
    #             "cleabs_zone": [ 

    #             ],
    #             "identifiant_de_l_etablissement": [

    #             ],
    #             "geometry": map(from_wkt, [

    #             ]),
    #         },
    #         crs=TEST_CRS
    #     ),
    # ),

    # Test 6 (#TODO) : 
    # Une zone est partagée entre deux établissements
    # Une autre zone est associée à un troisième établissement
    # Une des zones est inclue dans l'autre
    #  (
    #     # Test 6 : schools_establishments
    #     gpd.GeoDataFrame(
    #         {       
    #             "identifiant_de_l_etablissement": [

    #             ],
    #             "geometry": map(from_wkt, [

    #             ]),
    #         },
    #         crs=TEST_CRS
    #     ),
    #     # Test 6 : educational_zones
    #     gpd.GeoDataFrame(
    #         {
    #             "cleabs": [


    #             ],
    #             "identifiants_sources": [

    #             ],
    #             "geometry": map(from_wkt, [
          
    #             ]),
    #         },
    #         crs=TEST_CRS
    #     ), 
    #     # Test 6 : buildings
    #     gpd.GeoDataFrame(
    #         {
    #             "cleabs": [

    #             ],
    #             "geometry": map(from_wkt, [

    #             ]),
    #         },
    #         crs=TEST_CRS
    #     ),
    #     # Test 6 : schools_buildings_expected
    #     gpd.GeoDataFrame(
    #         {
    #             "cleabs_bat": [

    #             ],
    #             "cleabs_zone": [ 

    #             ],
    #             "identifiant_de_l_etablissement": [

    #             ],
    #             "geometry": map(from_wkt, [

    #             ]),
    #         },
    #         crs=TEST_CRS
    #     ),
    # ),
])
def test_attach_buildings_to_schools(
    schools_establishments, 
    educational_zones, 
    buildings, 
    schools_buildings_expected
):
    # init

    # call
    schools_buildings, schools_educational_zones = attach_buildings_to_schools(schools_establishments, educational_zones, buildings)

    # assert
    # on a le meme nombre de batiments
    assert len(schools_buildings) == len(schools_buildings_expected)

    # on retrouve les memes identifiants de batiments et affectation a un etablissement
    for _, building_expected in schools_buildings_expected.iterrows():
        building_id = building_expected.cleabs_bat

        assert building_id in schools_buildings["cleabs_bat"].unique()
        building = schools_buildings[schools_buildings["cleabs_bat"] == building_id].iloc[0]

        grande_zone_obtained = building.cleabs_grande_zone
        grande_zone_expected = building_expected.cleabs_grande_zone

        assert grande_zone_obtained == grande_zone_expected, "Building {} is expected with grande zone {} but was affected to {}".format(
            building_id, grande_zone_expected, grande_zone_obtained
        )

        etablissement_obtained = building.identifiant_de_l_etablissement
        etablissement_expected = building_expected.identifiant_de_l_etablissement

        assert etablissement_obtained == etablissement_expected, "Building {} is expected with etablissement {} but was affected to {}".format(
            building_id, etablissement_expected, etablissement_obtained
        )

        geometry_obtained = building.geometry
        geometry_expected = building_expected.geometry

        assert geometry_obtained == geometry_expected

